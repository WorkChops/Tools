<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WorkChops ‚Äî G√©n√©rateur de S√©quence</title>
  <meta name="description" content="Outil de tirage / s√©quen√ßage pour ateliers ‚Äî g√©n√©ration, partage (WhatsApp), capture PNG, presets locaux." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6fbff;
      --panel:#ffffff;
      --muted:#566078;
      --text:#0b1720;
      --primary:#1e66f5;
      --accent:#f59e0b;
      --danger:#dc2626;
      --border:#e6eef9;
      --radius:12px;
      --shadow: 0 8px 30px rgba(7,12,34,0.06);
      --ui: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      --mono: 'Roboto Mono', monospace;
      --focus: 3px solid rgba(30,102,245,0.14);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#071226;--panel:#081428;--muted:#9aa6b2;--text:#e6eef6;--primary:#4f8cff;--accent:#f6b95b;--border:rgba(255,255,255,0.04);--shadow:0 8px 30px rgba(2,6,23,0.6);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:var(--ui);background:linear-gradient(180deg,var(--bg),color-mix(in srgb,var(--bg) 85%, white 15%));color:var(--text);display:flex;align-items:center;justify-content:center;padding:20px}

    .wrap{width:100%;max-width:980px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--primary),color-mix(in srgb,var(--primary) 60%, white 20%));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    main.grid{display:grid;grid-template-columns:320px 1fr;gap:18px}

    .panel{background:var(--panel);border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .panel h3{margin:0 0 10px 0;font-size:14px}
    .muted{color:var(--muted);font-size:13px}

    /* Controls */
    .control-group{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    label{font-size:13px;font-weight:700;color:var(--text)}
    input[type=number],select,textarea,input[type=text]{padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:14px}
    textarea{min-height:88px;resize:vertical}

    .buttons{display:flex;flex-wrap:wrap;gap:10px}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;font-size:14px}
    .btn.primary{background:linear-gradient(90deg,var(--primary),color-mix(in srgb,var(--primary) 70%, white 10%));color:#fff;box-shadow:0 6px 18px rgba(30,102,245,0.12)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.warn{background:var(--accent);color:#0b1720}

    /* Sequence display */
    .sequence-area{display:flex;flex-direction:column;gap:12px}
    .sequence-row{display:flex;flex-wrap:wrap;gap:12px;padding:12px;border-radius:12px;border:1px dashed var(--border);min-height:120px;align-items:center;justify-content:center;background:linear-gradient(180deg,color-mix(in srgb,var(--panel) 96%, white 4%), color-mix(in srgb,var(--panel) 92%, var(--primary) 2%))}
    .box{min-width:72px;min-height:96px;border-radius:10px;background:var(--panel);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;color:var(--text);border:2px solid var(--border);position:relative;user-select:none}
    .box.locked{box-shadow:inset 0 0 0 3px rgba(255,210,84,0.06);}
    .box .index{position:absolute;top:6px;left:8px;font-size:11px;color:var(--muted);font-weight:700}
    .box .lock{position:absolute;top:6px;right:8px;font-size:12px;opacity:0.8}

    .small-muted{font-size:12px;color:var(--muted)}

    /* footer actions */
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

    /* presets list */
    .presets{display:flex;gap:8px;align-items:center;margin-top:8px}
    select.preset-select{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}

    /* responsive */
    @media (max-width:900px){main.grid{grid-template-columns:1fr} .sequence-row{min-height:100px} .box{min-width:56px;min-height:76px;font-size:22px}}

    /* accessibility */
    .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">WC</div>
        <div>
          <h1>WorkChops ‚Äî G√©n√©rateur de S√©quence</h1>
          <p class="lead">G√©n√©rez l'ordre des groupes, partagez rapidement (WhatsApp / Partage syst√®me) ou exportez une image.</p>
        </div>
      </div>
      <div class="muted">Utilisez Tab pour naviguer ‚Ä¢ Raccourcis: G=G√©n√©rer S=M√©langer C=Copier</div>
    </header>

    <main class="grid">
      <!-- Left panel: controls -->
      <aside class="panel" aria-labelledby="controlsTitle">
        <h3 id="controlsTitle">Contr√¥les</h3>

        <div class="control-group">
          <label for="mode">Mode</label>
          <select id="mode" aria-label="Mode de g√©n√©ration">
            <option value="numbers">Nombres (automatique)</option>
            <option value="labels">Liste (importer des noms)</option>
          </select>
        </div>

        <div id="numbersControls">
          <div class="control-group">
            <label for="count">Nombre d'√©l√©ments</label>
            <input id="count" type="number" min="1" max="50" value="3" />
          </div>
          <div style="display:flex;gap:10px">
            <div class="control-group" style="flex:1">
              <label for="min">Valeur min</label>
              <input id="min" type="number" value="1" />
            </div>
            <div class="control-group" style="flex:1">
              <label for="max">Valeur max</label>
              <input id="max" type="number" value="9" />
            </div>
          </div>
        </div>

        <div id="labelsControls" style="display:none">
          <div class="control-group">
            <label for="labels">Liste (s√©par√©e par une nouvelle ligne ou une virgule)</label>
            <textarea id="labels" placeholder="Ex: Groupe A,Groupe B,Groupe C"></textarea>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <label class="small-muted" style="margin:0"><input type="checkbox" id="allowDuplicates" /> Autoriser les doublons</label>
        </div>

        <div class="buttons" style="margin-bottom:6px">
          <button id="generateBtn" class="btn primary">G√©n√©rer (G)</button>
          <button id="shuffleBtn" class="btn ghost">M√©langer (S)</button>
          <button id="reverseBtn" class="btn ghost">Inverser</button>
        </div>

        <div style="margin-top:6px">
          <label class="small-muted">Presets</label>
          <div class="presets">
            <select id="presetList" class="preset-select" aria-label="Charger un preset"></select>
            <input id="presetName" type="text" placeholder="Nom du preset" style="padding:8px;border-radius:8px;border:1px solid var(--border);flex:1" />
            <button id="savePreset" class="btn ghost">Enregistrer</button>
            <button id="deletePreset" class="btn ghost">Supprimer</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />

        <div>
          <h3 style="margin:0 0 8px 0">Export / Partage</h3>
          <div class="muted" style="margin-bottom:8px">G√©n√©rez puis partagez ou exportez une capture.</div>

          <div class="buttons">
            <button id="copyBtn" class="btn ghost">Copier le texte (C)</button>
            <button id="downloadPngBtn" class="btn ghost">T√©l√©charger PNG</button>
            <button id="shareBtn" class="btn primary">Partager (Syst√®me)</button>
            <button id="waBtn" class="btn warn">WhatsApp</button>
          </div>

          <div style="margin-top:10px">
            <button id="downloadCsv" class="btn ghost">T√©l√©charger CSV</button>
            <button id="exportJson" class="btn ghost">Exporter JSON</button>
          </div>
        </div>
      </aside>

      <!-- Right panel: display -->
      <section>
        <div class="panel sequence-area">
          <div>
            <h3 style="margin:0 0 6px 0">S√©quence</h3>
            <div class="small-muted">Cliquez sur une case pour la verrouiller (elle sera ignor√©e lors des nouveaux tirages).</div>
          </div>

          <div class="sequence-row" id="sequenceRow" aria-live="polite"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px">
            <div class="small-muted">R√©sultat: <strong id="sequenceText">‚Äî</strong></div>
            <div class="actions">
              <button id="copyInlineBtn" class="btn ghost">Copier</button>
              <button id="imgInlineBtn" class="btn ghost">Aper√ßu PNG</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // State
    const state = {
      mode: 'numbers',
      count: 3,
      min: 1,
      max: 9,
      allowDuplicates: false,
      labels: [],
      sequence: [],
      locked: new Set(),
      presetsKey: 'wc_sequence_presets_v1'
    };

    // Elements
    const modeEl = document.getElementById('mode');
    const countEl = document.getElementById('count');
    const minEl = document.getElementById('min');
    const maxEl = document.getElementById('max');
    const labelsEl = document.getElementById('labels');
    const allowDupEl = document.getElementById('allowDuplicates');
    const generateBtn = document.getElementById('generateBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const reverseBtn = document.getElementById('reverseBtn');
    const sequenceRow = document.getElementById('sequenceRow');
    const sequenceText = document.getElementById('sequenceText');

    const copyBtn = document.getElementById('copyBtn');
    const downloadPngBtn = document.getElementById('downloadPngBtn');
    const shareBtn = document.getElementById('shareBtn');
    const waBtn = document.getElementById('waBtn');
    const downloadCsvBtn = document.getElementById('downloadCsv');
    const exportJsonBtn = document.getElementById('exportJson');

    const presetList = document.getElementById('presetList');
    const presetName = document.getElementById('presetName');
    const savePresetBtn = document.getElementById('savePreset');
    const deletePresetBtn = document.getElementById('deletePreset');

    const copyInlineBtn = document.getElementById('copyInlineBtn');
    const imgInlineBtn = document.getElementById('imgInlineBtn');

    // Init UI
    function applyMode(){
      document.getElementById('numbersControls').style.display = state.mode === 'numbers' ? 'block' : 'none';
      document.getElementById('labelsControls').style.display = state.mode === 'labels' ? 'block' : 'none';
    }

    modeEl.addEventListener('change', e => { state.mode = e.target.value; applyMode(); });
    countEl.addEventListener('change', e => state.count = Number(e.target.value || 0));
    minEl.addEventListener('change', e => state.min = Number(e.target.value || 0));
    maxEl.addEventListener('change', e => state.max = Number(e.target.value || 0));
    allowDupEl.addEventListener('change', e => state.allowDuplicates = e.target.checked);
    labelsEl.addEventListener('input', e => {
      state.labels = parseLabels(e.target.value);
    });

    function parseLabels(raw){
      if(!raw) return [];
      // split by new line or comma
      return raw.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
    }

    // Boxes
    function renderBoxes(){
      sequenceRow.innerHTML = '';
      const seq = state.sequence || [];
      seq.forEach((val, idx) => {
        const box = document.createElement('div');
        box.className = 'box' + (state.locked.has(idx) ? ' locked' : '');
        box.tabIndex = 0;
        box.setAttribute('role','button');
        box.setAttribute('aria-pressed', state.locked.has(idx) ? 'true' : 'false');

        const indexEl = document.createElement('div'); indexEl.className = 'index'; indexEl.textContent = idx+1;
        const lockEl = document.createElement('div'); lockEl.className = 'lock'; lockEl.innerHTML = state.locked.has(idx) ? 'üîí' : 'üîì';
        box.appendChild(indexEl);
        box.appendChild(lockEl);

        const value = document.createElement('div'); value.textContent = String(val);
        box.appendChild(value);

        // toggle lock on click / enter
        box.addEventListener('click', ()=> toggleLock(idx, box));
        box.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleLock(idx, box); } });

        sequenceRow.appendChild(box);
      });

      sequenceText.textContent = seq.length ? seq.join(' - ') : '‚Äî';
    }

    function toggleLock(idx, box){
      if(state.locked.has(idx)) state.locked.delete(idx); else state.locked.add(idx);
      renderBoxes();
    }

    // Generate logic
    function generateSequence(){
      // compute items source
      let items = [];
      if(state.mode === 'labels'){
        items = state.labels.slice();
        if(items.length === 0){ alert('Veuillez fournir au moins un label.'); return; }
      } else {
        // numbers
        const min = Number(state.min);
        const max = Number(state.max);
        if(isNaN(min) || isNaN(max) || min > max){ alert('Intervalle invalide.'); return; }
        for(let v=min; v<=max; v++) items.push(String(v));
      }

      const take = Number(state.count) || 0;
      if(!state.allowDuplicates && items.length < take){
        alert('Pas assez d\'√©l√©ments uniques pour produire la s√©quence. Activez les doublons ou r√©duisez le nombre.');
        return;
      }

      // Build pool
      let pool = [];
      if(state.allowDuplicates){
        // pick randomly with replacement
        pool = new Array(take).fill(null).map(()=> items[Math.floor(Math.random()*items.length)]);
      } else {
        // shuffle items and slice
        const copy = items.slice();
        for(let i=copy.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[copy[i],copy[j]]=[copy[j],copy[i]]}
        pool = copy.slice(0,take);
      }

      // Merge with locked positions: locked positions keep previous value if any, free positions fill from pool in order
      const result = [];
      let poolIndex = 0;
      for(let i=0;i<take;i++){
        if(state.locked.has(i) && state.sequence[i] !== undefined){ result[i] = state.sequence[i]; }
        else{
          // find next available from pool
          result[i] = pool[poolIndex++] || '';
        }
      }

      state.sequence = result;
      renderBoxes();
    }

    // Shuffle allowed slots
    function shuffleSequence(){
      const seq = state.sequence.slice();
      // collect unlocked indices
      const unlocked = seq.map((v,i)=> ({v,i})).filter(x=> !state.locked.has(x.i));
      // shuffle values
      for(let i=unlocked.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[unlocked[i].v,unlocked[j].v] = [unlocked[j].v,unlocked[i].v];}
      // apply back
      let k=0;
      for(let i=0;i<seq.length;i++){
        if(!state.locked.has(i)) seq[i] = unlocked[k++].v;
      }
      state.sequence = seq;
      renderBoxes();
    }

    function reverseSequence(){ state.sequence = (state.sequence||[]).slice().reverse(); renderBoxes(); }

    // Utilities: copy text
    async function copySequenceText(){
      const txt = (state.sequence && state.sequence.length) ? state.sequence.join(' - ') : '';
      if(!txt) return alert('Aucune s√©quence √† copier.');
      try{ await navigator.clipboard.writeText(txt); notif('S√©quence copi√©e'); }catch(e){ fallbackCopyText(txt); }
    }
    function fallbackCopyText(text){ const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); notif('S√©quence copi√©e (fallback)'); }

    // CSV / JSON
    function downloadCsv(){ if(!state.sequence.length) return alert('Aucune s√©quence √† exporter.'); const rows = state.sequence.map((v,i)=> `${i+1},"${String(v).replace(/"/g,'""')}`); const csv = 'Index,Value\n'+rows.join('\n'); downloadBlob(csv,'text/csv','sequence.csv'); }
    function exportJson(){ if(!state.sequence.length) return alert('Aucune s√©quence √† exporter.'); const json = {sequence: state.sequence, meta:{mode: state.mode}}; downloadBlob(JSON.stringify(json,null,2),'application/json','sequence.json'); }
    function downloadBlob(content,type,filename){ const blob = new Blob([content],{type}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    // SVG -> PNG generation for sharing / download
    async function exportSequencePng(){ if(!state.sequence.length) return alert('Aucune s√©quence √† exporter.');
      const svg = buildSequenceSvg(state.sequence);
      const blob = new Blob([svg],{type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      try{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        const load = new Promise((res,rej)=>{ img.onload = res; img.onerror = rej; });
        img.src = url;
        await load;
        const canvas = document.createElement('canvas');
        canvas.width = img.width; canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel') || '#fff';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0);
        URL.revokeObjectURL(url);
        // produce blob
        const blobPng = await new Promise(res=> canvas.toBlob(res,'image/png'));
        return blobPng;
      }catch(e){ URL.revokeObjectURL(url); console.error(e); alert('Erreur lors de la g√©n√©ration PNG'); return null; }
    }

    function buildSequenceSvg(seq){
      // build a simple horizontal SVG with boxes and text
      const padding = 24;
      const boxW = 110;
      const boxH = 140;
      const gap = 12;
      const width = padding*2 + seq.length*boxW + Math.max(0, (seq.length-1))*gap;
      const height = padding*2 + boxH + 70; // extra for title
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#ffffff';
      const colorText = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0b1720';
      const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#1e66f5';

      // escape values for xml
      function esc(t){ return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      let x = padding;
      const boxes = seq.map((v,i)=>{
        const rx = x; x += boxW + gap;
        return `<g transform=\"translate(${rx},${padding+40})\">`+
          `<rect x=\"0\" y=\"0\" width=\"${boxW}\" height=\"${boxH}\" rx=\"10\" fill=\"${bg}\" stroke=\"${primary}\" stroke-width=\"2\"></rect>`+
          `<text x=\"${boxW/2}\" y=\"${boxH/2+10}\" font-family=\"Inter, Arial, sans-serif\" font-size=\"26\" fill=\"${colorText}\" text-anchor=\"middle\">${esc(v)}</text>`+
          `<text x=\"8\" y=\"16\" font-family=\"Inter, Arial, sans-serif\" font-size=\"12\" fill=\"${colorText}\">${i+1}</text>`+
          `</g>`;
      }).join('\n');

      const title = `<text x=\"${width/2}\" y=\"28\" font-family=\"Inter, Arial, sans-serif\" font-size=\"20\" font-weight=\"700\" fill=\"${primary}\" text-anchor=\"middle\">WorkChops ‚Äî S√©quence</text>`;

      const svg = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${width}\" height=\"${height}\">\n  <rect width=\"100%\" height=\"100%\" fill=\"${bg}\" />\n  ${title}\n  ${boxes}\n</svg>`;
      return svg;
    }

    // Share via Web Share API (with image if available)
    async function shareSequence(){
      if(!state.sequence.length){ return alert('Aucune s√©quence √† partager'); }
      const text = state.sequence.join(' - ');
      // try image
      const blob = await exportSequencePng();
      if(blob && navigator.canShare && navigator.canShare({files:[new File([blob],'sequence.png',{type:'image/png'})]})){
        try{
          const file = new File([blob],'workchops-sequence.png',{type:'image/png'});
          await navigator.share({ files:[file], title:'WorkChops ‚Äî S√©quence', text });
          return;
        }catch(e){ console.warn('share failed',e); }
      }
      // fallback to text share or copy
      if(navigator.share){ try { await navigator.share({ title: 'WorkChops ‚Äî S√©quence', text }); return; } catch(e) { console.warn(e); } }
      // final fallback open whatsapp with text
      shareWhatsAppText(text);
    }

    function shareWhatsAppText(text){
      const encoded = encodeURIComponent(text + '\n\n(Partag√© depuis WorkChops)');
      const url = `https://wa.me/?text=${encoded}`;
      window.open(url,'_blank');
    }

    // Download PNG
    async function downloadPng(){ const blob = await exportSequencePng(); if(!blob) return; const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'workchops-sequence.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    // Presets (localStorage)
    function loadPresets(){ const raw = localStorage.getItem(state.presetsKey); try{ const obj = raw ? JSON.parse(raw) : {}; // obj: {name: config}
      presetList.innerHTML = '<option value="">-- Aucun --</option>';
      Object.keys(obj).forEach(k=>{ const opt = document.createElement('option'); opt.value = k; opt.textContent = k; presetList.appendChild(opt); });
      return obj;
    }catch(e){ console.warn('invalid presets',e); return {}; } }

    function savePreset(){ const name = (presetName.value || '').trim(); if(!name) return alert('Donnez un nom au preset'); const obj = loadPresets(); obj[name] = {mode: state.mode, count: state.count, min: state.min, max: state.max, labels: state.labels, allowDuplicates: state.allowDuplicates}; localStorage.setItem(state.presetsKey, JSON.stringify(obj)); notif('Preset enregistr√©'); refreshPresets(); }
    function deletePreset(){ const name = presetList.value; if(!name) return alert('Choisissez un preset'); const obj = loadPresets(); delete obj[name]; localStorage.setItem(state.presetsKey, JSON.stringify(obj)); notif('Preset supprim√©'); refreshPresets(); }
    function refreshPresets(){ const obj = loadPresets(); /* already populated */ }
    presetList.addEventListener('change', ()=>{
      const name = presetList.value; if(!name) return; const obj = loadPresets(); const cfg = obj[name]; if(!cfg) return; state.mode = cfg.mode || 'numbers'; state.count = cfg.count || 3; state.min = cfg.min || 1; state.max = cfg.max || 9; state.labels = cfg.labels || []; state.allowDuplicates = !!cfg.allowDuplicates;
      // apply to UI
      modeEl.value = state.mode; countEl.value = state.count; minEl.value = state.min; maxEl.value = state.max; labelsEl.value = (state.labels||[]).join('\n'); allowDupEl.checked = state.allowDuplicates; applyMode(); notif('Preset charg√©');
    });
    savePresetBtn.addEventListener('click', savePreset); deletePresetBtn.addEventListener('click', deletePreset);

    // Notifications small
    function notif(msg){ try{ const n = document.createElement('div'); n.textContent = msg; n.style.position='fixed'; n.style.right='20px'; n.style.bottom='20px'; n.style.background='rgba(0,0,0,0.8)'; n.style.color='#fff'; n.style.padding='10px 14px'; n.style.borderRadius='8px'; n.style.zIndex=9999; document.body.appendChild(n); setTimeout(()=> n.remove(),1600); }catch(e){} }

    // CSV / JSON buttons
    downloadCsvBtn.addEventListener('click', downloadCsv); exportJsonBtn.addEventListener('click', exportJson);

    // share / copy buttons
    copyBtn.addEventListener('click', copySequenceText); copyInlineBtn.addEventListener('click', copySequenceText);
    waBtn.addEventListener('click', ()=> { if(!state.sequence.length) return alert('G√©n√©rez d\'abord la s√©quence'); shareWhatsAppText(state.sequence.join(' - ')); });
    shareBtn.addEventListener('click', () => shareSequence());
    downloadPngBtn.addEventListener('click', downloadPng); imgInlineBtn.addEventListener('click', async ()=>{ const blob = await exportSequencePng(); if(blob) { const url = URL.createObjectURL(blob); window.open(url,'_blank'); } });

    // basic keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; // ignore typing
      if(e.key.toLowerCase() === 'g') { generateBtn.click(); }
      if(e.key.toLowerCase() === 's') { shuffleBtn.click(); }
      if(e.key.toLowerCase() === 'c') { copyBtn.click(); }
    });

    // connect main buttons
    generateBtn.addEventListener('click', ()=>{
      // read latest UI values
      state.mode = modeEl.value;
      state.count = Number(countEl.value) || 0;
      state.min = Number(minEl.value) || 0;
      state.max = Number(maxEl.value) || 0;
      state.allowDuplicates = allowDupEl.checked;
      if(state.mode === 'labels') state.labels = parseLabels(labelsEl.value);
      // initialize locked to current length if sequence shorter
      if(!state.sequence || state.sequence.length !== state.count) state.locked = new Set();
      generateSequence();
    });

    shuffleBtn.addEventListener('click', ()=>{ if(!state.sequence || !state.sequence.length) return alert('G√©n√©rez une s√©quence d\'abord'); shuffleSequence(); });
    reverseBtn.addEventListener('click', ()=>{ reverseSequence(); });

    // Presets load on start
    refreshPresets();
    // populate presetList
    (function(){ const obj = loadPresets(); refreshPresets(); })();

    // initial render
    state.sequence = Array.from({length: state.count}, (_,i)=> String(state.min + i));
    renderBoxes();

  </script>
</body>
</html>
